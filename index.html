<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é (YOLO + Caption + Translation)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f4f7f6; color: #333; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { margin-top: 0; color: #2c3e50; }
        
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.2s; font-weight: 600; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        button.success { background: #28a745; }
        button.secondary { background: #6c757d; margin-top: 10px; }

        #log { height: 250px; overflow-y: auto; background: #1e1e1e; color: #00ff9d; padding: 15px; font-family: 'Consolas', monospace; border-radius: 8px; margin-top: 15px; font-size: 13px; border: 1px solid #333; }
        
        .progress-container { width: 100%; background: #e2e8f0; height: 24px; border-radius: 12px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #007bff, #00c6ff); width: 0%; transition: width 0.3s; }
        
        .stat-box { display: flex; gap: 30px; margin-bottom: 15px; font-weight: bold; font-size: 1.1em; }
        
        #resultModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; width: 80%; height: 80%; border-radius: 10px; display: flex; flex-direction: column; }
        textarea { width: 100%; height: 100%; margin-top: 10px; font-family: monospace; border: 1px solid #ccc; border-radius: 5px; padding: 10px; resize: none; font-size: 14px; }
        .close-btn { align-self: flex-end; cursor: pointer; font-size: 20px; font-weight: bold; color: #555; background: #eee; padding: 5px 15px; border-radius: 5px; }
        .close-btn:hover { background: #ddd; }
    </style>
</head>
<body>

    <div class="card">
        <h1>üá∫üá¶ AI –û–±—Ä–æ–±–∫–∞ –ó–æ–±—Ä–∞–∂–µ–Ω—å</h1>
        <p>–°–∏—Å—Ç–µ–º–∞ –≤–∏–∫–æ–Ω—É—î —Ç—Ä–∏ –¥—ñ—ó –ª–æ–∫–∞–ª—å–Ω–æ:</p>
        <ol style="margin-top: 0;">
            <li>–ó–Ω–∞—Ö–æ–¥–∏—Ç—å –æ–±'—î–∫—Ç–∏ (YOLO) —Ç–∞ –ø—ñ–¥–ø–∏—Å—É—î —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é.</li>
            <li>–ì–µ–Ω–µ—Ä—É—î –æ–ø–∏—Å —Å—Ü–µ–Ω–∏ (Captioning).</li>
            <li>–ü–µ—Ä–µ–∫–ª–∞–¥–∞—î –æ–ø–∏—Å —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.</li>
        </ol>
        
        <div id="modelStatus" style="margin-bottom: 15px; font-weight: bold; color: #d69e2e;">‚è≥ –ó–∞—á–µ–∫–∞–π—Ç–µ, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é –º–æ–¥–µ–ª—ñ (—Ü–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ —Ö–≤–∏–ª–∏–Ω—É)...</div>
        <button id="folderBtn" disabled>üìÇ –û–±—Ä–∞—Ç–∏ –ø–∞–ø–∫—É</button>
    </div>

    <div class="card" id="processingArea" style="display:none;">
        <div class="stat-box">
            <div>–í—Å—å–æ–≥–æ: <span id="totalCount">0</span></div>
            <div>–û–±—Ä–æ–±–ª–µ–Ω–æ: <span id="processedCount">0</span></div>
        </div>
        <div class="progress-container"><div class="progress-fill" id="progressFill"></div></div>
        <div id="log"></div>
        <button id="viewResultsBtn" class="secondary" style="display:none;">üìÑ –í—ñ–¥–∫—Ä–∏—Ç–∏ –∑–≤—ñ—Ç (JSON)</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ -->
    <div id="resultModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç (results.json)</h3>
                <span class="close-btn" id="closeModal">–ó–∞–∫—Ä–∏—Ç–∏</span>
            </div>
            <textarea id="jsonViewer" readonly></textarea>
        </div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';

        // --- 1. –°–ª–æ–≤–Ω–∏–∫ –¥–ª—è –æ–±'—î–∫—Ç—ñ–≤ (COCO classes -> –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞) ---
        const OBJECT_TRANSLATION = {
            "person": "–ª—é–¥–∏–Ω–∞", "bicycle": "–≤–µ–ª–æ—Å–∏–ø–µ–¥", "car": "–∞–≤—Ç–æ", "motorcycle": "–º–æ—Ç–æ—Ü–∏–∫–ª", "airplane": "–ª—ñ—Ç–∞–∫",
            "bus": "–∞–≤—Ç–æ–±—É—Å", "train": "–ø–æ—Ç—è–≥", "truck": "–≤–∞–Ω—Ç–∞–∂—ñ–≤–∫–∞", "boat": "—á–æ–≤–µ–Ω", "traffic light": "—Å–≤—ñ—Ç–ª–æ—Ñ–æ—Ä",
            "fire hydrant": "–≥—ñ–¥—Ä–∞–Ω—Ç", "stop sign": "–∑–Ω–∞–∫ —Å—Ç–æ–ø", "parking meter": "–ø–∞—Ä–∫–æ–º–∞—Ç", "bench": "–ª–∞–≤–∫–∞",
            "bird": "–ø—Ç–∞—Ö", "cat": "–∫—ñ—Ç", "dog": "—Å–æ–±–∞–∫–∞", "horse": "–∫—ñ–Ω—å", "sheep": "–≤—ñ–≤—Ü—è", "cow": "–∫–æ—Ä–æ–≤–∞",
            "elephant": "—Å–ª–æ–Ω", "bear": "–≤–µ–¥–º—ñ–¥—å", "zebra": "–∑–µ–±—Ä–∞", "giraffe": "–∂–∏—Ä–∞—Ñ–∞", "backpack": "—Ä—é–∫–∑–∞–∫",
            "umbrella": "–ø–∞—Ä–∞—Å–æ–ª—è", "handbag": "—Å—É–º–∫–∞", "tie": "–∫—Ä–∞–≤–∞—Ç–∫–∞", "suitcase": "–≤–∞–ª—ñ–∑–∞", "frisbee": "—Ñ—Ä—ñ–∑–±—ñ",
            "skis": "–ª–∏–∂—ñ", "snowboard": "—Å–Ω–æ—É–±–æ—Ä–¥", "sports ball": "–º'—è—á", "kite": "–ø–æ–≤—ñ—Ç—Ä—è–Ω–∏–π –∑–º—ñ–π", "baseball bat": "–±–∏—Ç–∞",
            "baseball glove": "—Ä—É–∫–∞–≤–∏—Ü—è", "skateboard": "—Å–∫–µ–π—Ç", "surfboard": "—Å–µ—Ä—Ñ", "tennis racket": "—Ä–∞–∫–µ—Ç–∫–∞",
            "bottle": "–ø–ª—è—à–∫–∞", "wine glass": "–∫–µ–ª–∏—Ö", "cup": "—á–∞—à–∫–∞", "fork": "–≤–∏–¥–µ–ª–∫–∞", "knife": "–Ω—ñ–∂", "spoon": "–ª–æ–∂–∫–∞",
            "bowl": "–º–∏—Å–∫–∞", "banana": "–±–∞–Ω–∞–Ω", "apple": "—è–±–ª—É–∫–æ", "sandwich": "—Å–µ–Ω–¥–≤—ñ—á", "orange": "–∞–ø–µ–ª—å—Å–∏–Ω",
            "broccoli": "–±—Ä–æ–∫–æ–ª—ñ", "carrot": "–º–æ—Ä–∫–≤–∞", "hot dog": "—Ö–æ—Ç-–¥–æ–≥", "pizza": "–ø—ñ—Ü–∞", "donut": "–ø–æ–Ω—á–∏–∫",
            "cake": "—Ç–æ—Ä—Ç", "chair": "—Å—Ç—ñ–ª–µ—Ü—å", "couch": "–¥–∏–≤–∞–Ω", "potted plant": "–≤–∞–∑–æ–Ω", "bed": "–ª—ñ–∂–∫–æ",
            "dining table": "—Å—Ç—ñ–ª", "toilet": "—Ç—É–∞–ª–µ—Ç", "tv": "—Ç–µ–ª–µ–≤—ñ–∑–æ—Ä", "laptop": "–Ω–æ—É—Ç–±—É–∫", "mouse": "–º–∏—à–∞",
            "remote": "–ø—É–ª—å—Ç", "keyboard": "–∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞", "cell phone": "—Ç–µ–ª–µ—Ñ–æ–Ω", "microwave": "–º—ñ–∫—Ä–æ—Ö–≤–∏–ª—å–æ–≤–∫–∞",
            "oven": "–ø—ñ—á", "toaster": "—Ç–æ—Å—Ç–µ—Ä", "sink": "—Ä–∞–∫–æ–≤–∏–Ω–∞", "refrigerator": "—Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫", "book": "–∫–Ω–∏–≥–∞",
            "clock": "–≥–æ–¥–∏–Ω–Ω–∏–∫", "vase": "–≤–∞–∑–∞", "scissors": "–Ω–æ–∂–∏—Ü—ñ", "teddy bear": "–≤–µ–¥–º–µ–¥–∏–∫", "hair drier": "—Ñ–µ–Ω",
            "toothbrush": "—â—ñ—Ç–∫–∞"
        };

        env.allowLocalModels = false;
        env.useBrowserCache = true;

        const modelStatus = document.getElementById('modelStatus');
        const folderBtn = document.getElementById('folderBtn');
        const logDiv = document.getElementById('log');
        const progressFill = document.getElementById('progressFill');
        const processingArea = document.getElementById('processingArea');
        const totalCountSpan = document.getElementById('totalCount');
        const processedCountSpan = document.getElementById('processedCount');
        const viewResultsBtn = document.getElementById('viewResultsBtn');
        const resultModal = document.getElementById('resultModal');
        const jsonViewer = document.getElementById('jsonViewer');
        const closeModal = document.getElementById('closeModal');

        let detector = null;
        let captioner = null;
        let translator = null;
        let savedJsonHandle = null;

        function log(msg) {
            logDiv.textContent += `> ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // --- 2. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π ---
        async function loadModels() {
            try {
                log("1/3 –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ (YOLOS)...");
                detector = await pipeline('object-detection', 'Xenova/yolos-tiny');
                
                log("2/3 –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –æ–ø–∏—Å—ñ–≤ (ViT-GPT2)...");
                captioner = await pipeline('image-to-text', 'Xenova/vit-gpt2-image-captioning');

                log("3/3 –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞ (EN -> UK)...");
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Opus-MT –¥–ª—è –ø–µ—Ä–µ–∫–ª–∞–¥—É —Ä–µ—á–µ–Ω—å
                translator = await pipeline('translation', 'Xenova/opus-mt-en-uk');

                modelStatus.textContent = '‚úÖ –í—Å—ñ —Å–∏—Å—Ç–µ–º–∏ –≥–æ—Ç–æ–≤—ñ. –ú–æ–∂–Ω–∞ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏.';
                modelStatus.style.color = 'green';
                folderBtn.disabled = false;
            } catch (err) {
                modelStatus.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + err.message;
                log('–î–µ—Ç–∞–ª—ñ: ' + err);
            }
        }
        loadModels();

        folderBtn.addEventListener('click', async () => {
            if (!window.showDirectoryPicker) { alert("–ü–æ—Ç—Ä—ñ–±–µ–Ω Chrome/Edge."); return; }

            try {
                const dirHandle = await window.showDirectoryPicker();
                const opts = { mode: 'readwrite' };
                if ((await dirHandle.queryPermission(opts)) !== 'granted') {
                    if ((await dirHandle.requestPermission(opts)) !== 'granted') return;
                }

                processingArea.style.display = 'block';
                folderBtn.disabled = true;
                
                const processedDirHandle = await dirHandle.getDirectoryHandle('processed_ua', { create: true });

                const images = [];
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file' && entry.name.match(/\.(jpg|jpeg|png|webp)$/i)) {
                        images.push(entry);
                    }
                }

                totalCountSpan.textContent = images.length;
                let processedCount = 0;
                const jsonResults = [];
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                for (const fileHandle of images) {
                    const file = await fileHandle.getFile();
                    const url = URL.createObjectURL(file);
                    
                    try {
                        const img = new Image();
                        await new Promise((r, e) => { img.onload = r; img.onerror = e; img.src = url; });

                        // --- –ü–ê–†–ê–õ–ï–õ–¨–ù–ò–ô –ó–ê–ü–£–°–ö ---
                        const [detOutput, capOutput] = await Promise.all([
                            detector(url, { threshold: 0.5, percentage: true }),
                            captioner(url)
                        ]);

                        // --- –ü–ï–†–ï–ö–õ–ê–î –û–ü–ò–°–£ ---
                        const engDesc = capOutput[0].generated_text;
                        let ukrDesc = engDesc;
                        try {
                            const transOutput = await translator(engDesc);
                            ukrDesc = transOutput[0].translation_text;
                        } catch (e) {
                            console.warn("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–∫–ª–∞–¥—É –æ–ø–∏—Å—É", e);
                        }

                        // --- –ú–ê–õ–Æ–í–ê–ù–ù–Ø ---
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        ctx.lineWidth = 3;
                        ctx.font = 'bold 20px Arial'; // –ó–±—ñ–ª—å—à–µ–Ω–∏–π —à—Ä–∏—Ñ—Ç
                        ctx.textBaseline = 'top';

                        const detectedObjects = [];

                        detOutput.forEach(pred => {
                            let { box, label, score } = pred;
                            
                            // 1. –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –ö–û–û–†–î–ò–ù–ê–¢ (Fix bugs)
                            // –Ø–∫—â–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ (0-1), –º–∞—Å—à—Ç–∞–±—É—î–º–æ —ó—Ö
                            let { xmax, xmin, ymax, ymin } = box;
                            if (xmax <= 1.05 && ymax <= 1.05) { 
                                xmin *= img.width; xmax *= img.width;
                                ymin *= img.height; ymax *= img.height;
                            }

                            // 2. –ü–ï–†–ï–ö–õ–ê–î –û–ë'–Ñ–ö–¢–ê
                            const labelUkr = OBJECT_TRANSLATION[label] || label;
                            
                            // –ö–æ–ª—ñ—Ä —Ä–∞–º–∫–∏ (–≤–∏–ø–∞–¥–∫–æ–≤–∏–π —è—Å–∫—Ä–∞–≤–∏–π)
                            const color = `hsl(${Math.random() * 360}, 100%, 50%)`;

                            // –†–∞–º–∫–∞ (–ø—É–Ω–∫—Ç–∏—Ä)
                            ctx.setLineDash([10, 5]);
                            ctx.strokeStyle = color;
                            ctx.strokeRect(xmin, ymin, xmax - xmin, ymax - ymin);
                            
                            // –§–æ–Ω –¥–ª—è —Ç–µ–∫—Å—Ç—É (—Å—É—Ü—ñ–ª—å–Ω–∏–π)
                            ctx.setLineDash([]);
                            const text = `${labelUkr}`;
                            const txtMetrics = ctx.measureText(text);
                            const txtH = 24; 
                            
                            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ–± —Ç–µ–∫—Å—Ç –Ω–µ –≤–∏–ª—ñ–∑ –∑–∞ –º–µ–∂—ñ –∑–≤–µ—Ä—Ö—É
                            let textY = ymin - txtH;
                            if (textY < 0) textY = ymin; 

                            ctx.fillStyle = color;
                            ctx.fillRect(xmin, textY, txtMetrics.width + 10, txtH);
                            
                            // –¢–µ–∫—Å—Ç
                            ctx.fillStyle = '#ffffff';
                            ctx.fillText(text, xmin + 5, textY + 2);

                            detectedObjects.push({
                                label: labelUkr,
                                score: score,
                                box: { xmin, ymin, xmax, ymax }
                            });
                        });

                        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –æ–±—Ä–æ–±–ª–µ–Ω–æ—ó –∫–∞—Ä—Ç–∏–Ω–∫–∏
                        const blob = await new Promise(r => canvas.toBlob(r, file.type));
                        const newFileHandle = await processedDirHandle.getFileHandle(file.name, { create: true });
                        const writable = await newFileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();

                        // JSON –∑–∞–ø–∏—Å
                        jsonResults.push({
                            filename: file.name,
                            description_uk: ukrDesc,
                            description_en: engDesc,
                            objects: detectedObjects
                        });

                        log(`[OK] ${file.name}: ${ukrDesc}`);

                    } catch (err) {
                        log(`[ERR] ${file.name}: ${err.message}`);
                        console.error(err);
                    } finally {
                        URL.revokeObjectURL(url);
                        processedCount++;
                        processedCountSpan.textContent = processedCount;
                        progressFill.style.width = `${(processedCount / images.length) * 100}%`;
                    }
                }

                // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è JSON
                savedJsonHandle = await dirHandle.getFileHandle('results_ukr.json', { create: true });
                const writable = await savedJsonHandle.createWritable();
                await writable.write(JSON.stringify(jsonResults, null, 2));
                await writable.close();

                log("üéâ –ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–∞–ø–∫—É processed_ua —Ç–∞ —Ñ–∞–π–ª results_ukr.json");
                folderBtn.textContent = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ";
                folderBtn.classList.add('success');
                viewResultsBtn.style.display = 'inline-block';

            } catch (err) {
                console.error(err);
                if (err.name !== 'AbortError') log("CRITICAL ERROR: " + err.message);
                folderBtn.disabled = false;
            }
        });

        viewResultsBtn.addEventListener('click', async () => {
            if (!savedJsonHandle) return;
            try {
                const file = await savedJsonHandle.getFile();
                const text = await file.text();
                jsonViewer.value = text;
                resultModal.style.display = 'flex';
            } catch (err) { alert(err.message); }
        });

        closeModal.addEventListener('click', () => resultModal.style.display = 'none');
    </script>
</body>
</html>